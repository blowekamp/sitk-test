<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<!-- Google Tag Manager -->
<script>
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
  {'gtm.start': new Date().getTime(),event:'gtm.js'}
  );var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-N38XC8T');
</script>
<!-- End Google Tag Manager -->
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SimpleITK: DicomConvert/DicomConvert.R</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-N38XC8T"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager (noscript) -->
<script>
  $(function(){
      $("#datetime").load("datetime.txt");
      $("#projectnumber").load("projectnumber.txt");
  });
</script>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SimpleITK
   &#160;<span id="projectnumber">unknown</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">DicomConvert/DicomConvert.R</div></div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line">#=========================================================================</div>
<div class="line">#</div>
<div class="line">#  Copyright NumFOCUS</div>
<div class="line">#</div>
<div class="line">#  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</div>
<div class="line">#  you may not use this file except in compliance with the License.</div>
<div class="line">#  You may obtain a copy of the License at</div>
<div class="line">#</div>
<div class="line">#         http://www.apache.org/licenses/LICENSE-2.0.txt</div>
<div class="line">#</div>
<div class="line">#  Unless required by applicable law or agreed to in writing, software</div>
<div class="line">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</div>
<div class="line">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</div>
<div class="line">#  See the License for the specific language governing permissions and</div>
<div class="line">#  limitations under the License.</div>
<div class="line">#</div>
<div class="line">#=========================================================================</div>
<div class="line"># Run with:</div>
<div class="line">#</div>
<div class="line"># Rscript --vanilla DicomConvert.R root_of_data_directory output_file_extension --w new_image_width --od output_directory</div>
<div class="line">#</div>
<div class="line"> </div>
<div class="line">library(SimpleITK)</div>
<div class="line">library(argparser)</div>
<div class="line"> </div>
<div class="line">convert_image &lt;- function(input_file_name, output_file_name, new_width = NA)</div>
<div class="line">{</div>
<div class="line">  image_file_reader = ImageFileReader()</div>
<div class="line">  # only read DICOM images</div>
<div class="line">  image_file_reader$SetImageIO(&#39;GDCMImageIO&#39;)</div>
<div class="line">  image_file_reader$SetFileName(input_file_name)</div>
<div class="line">  try(image_file_reader$ReadImageInformation(), silent = TRUE)</div>
<div class="line">  image_size &lt;- image_file_reader$GetSize()</div>
<div class="line">  #if this isn&#39;t a DICOM image return FALSE</div>
<div class="line">  if(length(image_size) == 0) {</div>
<div class="line">    return(FALSE)</div>
<div class="line">  }</div>
<div class="line">  if(length(image_size) == 3 &amp; image_size[3] == 1) {</div>
<div class="line">    image_size[3] &lt;- 0</div>
<div class="line">    image_file_reader$SetExtractSize(image_size)</div>
<div class="line">  }</div>
<div class="line">  image &lt;- NULL</div>
<div class="line">  try(image &lt;- image_file_reader$Execute(), silent = TRUE)</div>
<div class="line">  if(is.null(image))</div>
<div class="line">  {</div>
<div class="line">    return(FALSE)</div>
<div class="line">  }</div>
<div class="line">  if(!is.na(new_width))</div>
<div class="line">  {</div>
<div class="line">    original_size &lt;- image$GetSize()</div>
<div class="line">    original_spacing &lt;- image$GetSpacing()</div>
<div class="line">    new_spacing &lt;- c((original_size[1]-1)*original_spacing[1]/(new_width-1),</div>
<div class="line">                    (original_size[1]-1)*original_spacing[1]/(new_width-1))</div>
<div class="line">    new_size &lt;- c(new_width, as.integer((original_size[2]-1)*original_spacing[2]/new_spacing[2]))</div>
<div class="line">    image &lt;- Resample(image, new_size, Transform(), &#39;sitkLinear&#39;,</div>
<div class="line">                      image$GetOrigin(), new_spacing, image$GetDirection(),0,</div>
<div class="line">                      image$GetPixelID())</div>
<div class="line">  }</div>
<div class="line">  # If a single channel image, rescale to [0,255]. Also modify the intensity values based</div>
<div class="line">  # on the photomertic interpretation. If MONOCHROME2 (minimum should be displayed as black) we</div>
<div class="line">  # don&#39;t need to do anything, if image has MONOCRHOME1 (minimum should be displayed as white) we flip</div>
<div class="line">  # the intensities. This is a constraint imposed by ITK which always assumes MONOCHROME2.</div>
<div class="line">  if(image$GetNumberOfComponentsPerPixel() == 1)</div>
<div class="line">  {</div>
<div class="line">    image &lt;- RescaleIntensity(image, 0, 255)</div>
<div class="line">    if(trimws(image_file_reader$GetMetaData(&#39;0028|0004&#39;)) == &#39;MONOCHROME1&#39;)</div>
<div class="line">    {</div>
<div class="line">      image &lt;-  InvertIntensity(image, maximum=255)</div>
<div class="line">    }</div>
<div class="line">    image &lt;- Cast(image, &#39;sitkUInt8&#39;)</div>
<div class="line">  }</div>
<div class="line">  WriteImage(image, output_file_name)</div>
<div class="line">  return(TRUE)</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line">parser&lt;-arg_parser(&#39;Convert and resize DICOM files to common image types.&#39;)</div>
<div class="line">parser&lt;-add_argument(parser, &#39;root_of_data_directory&#39;, help=&#39;Path to the topmost directory containing data.&#39;)</div>
<div class="line">parser&lt;-add_argument(parser, &#39;output_file_extension&#39;, help=&#39;Image file extension, this determines output file type (e.g. png) .&#39;)</div>
<div class="line">parser&lt;-add_argument(parser, &#39;--w&#39;, help=&#39;Width of converted images.&#39;)</div>
<div class="line">parser&lt;-add_argument(parser, &#39;--od&#39;, help=&#39;Output directory.&#39;)</div>
<div class="line">argv&lt;-parse_args(parser)</div>
<div class="line"> </div>
<div class="line">input_file_names &lt;- list.files(argv$root_of_data_directory, recursive=TRUE, full.names=TRUE)</div>
<div class="line">if(!is.na(argv$od)) {</div>
<div class="line">  # if all output files are written to the same directory we need them to have a unique name, so use an index.</div>
<div class="line">  file_names &lt;- lapply(seq_len(length(input_file_names)), function(new_file_name) return(file.path(argv$od, toString(new_file_name))))</div>
<div class="line">} else {</div>
<div class="line">  file_names &lt;- input_file_names</div>
<div class="line">}</div>
<div class="line">#append the file extension to the output file names</div>
<div class="line">output_file_names &lt;- lapply(file_names, function(file_name) return(paste0(file_name,&#39;.&#39;,argv$output_file_extension)))</div>
<div class="line">res &lt;- mapply(convert_image, input_file_names, output_file_names, new_width=as.integer(argv$w), SIMPLIFY=FALSE)</div>
<div class="line">df &lt;- data.frame(input_file_name = unlist(input_file_names[unlist(res)]),</div>
<div class="line">                output_file_name = unlist(output_file_names[unlist(res)]))</div>
<div class="line">dir_name &lt;- if(!is.na(argv$od)) argv$od else getwd()</div>
<div class="line">write.csv(df,file.path(dir_name, &#39;file_names.csv&#39;), row.names=FALSE)</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
    Generated on <span id="datetime">unknown</span> for SimpleITK by &#160;
    <a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.9.2 | <a href="https://simpleitk.org/privacy_policy.html">
      Privacy Policy</a>
</small></address>
</body>
</html>
